<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>乐谱详情</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #e0e7ff 0%, #f8fafc 100%);
            min-height: 100vh;
        }
        .score-container {
            max-width: 900px;
            margin: 2rem auto;
            background: #fff;
            border-radius: 1.5rem;
            box-shadow: 0 8px 32px rgba(60,60,120,0.10), 0 1.5px 8px rgba(60,60,120,0.08);
            padding: 2.5rem 2rem 2rem 2rem;
            position: relative;
        }
        .score-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
        }
        .score-title {
            font-size: 2.2rem;
            font-weight: bold;
            color: #3730a3;
            letter-spacing: 0.05em;
            position: relative;
        }
        .score-title::after {
            content: '';
            display: block;
            margin: 0.5rem auto 0 auto;
            width: 60px;
            height: 4px;
            border-radius: 2px;
            background: linear-gradient(90deg, #6366f1 0%, #a5b4fc 100%);
        }
        .back-btn {
            color: #6366f1;
            font-size: 1.7rem;
            border: none;
            background: none;
            cursor: pointer;
            transition: color 0.2s, transform 0.2s;
        }
        .back-btn:hover {
            color: #3730a3;
            transform: scale(1.15);
        }
        .audio-bar {
            margin-bottom: 2.5rem;
            background: #eef2ff;
            border-radius: 0.75rem;
            padding: 1.2rem 1rem 1rem 1rem;
            box-shadow: 0 2px 8px rgba(99,102,241,0.07);
            display: flex;
            align-items: center;
            gap: 1.2rem;
        }
        .audio-bar audio {
            flex: 1;
        }
        #pdf-viewer {
            width: 100%;
            min-height: 400px;
            background: #f7fafc;
            border-radius: 0.75rem;
            overflow: auto;
            box-shadow: 0 2px 8px rgba(99,102,241,0.06);
            padding: 1.5rem 0;
        }
        .score-page {
            margin: 1.5rem auto;
            box-shadow: 0 2px 12px rgba(99,102,241,0.10);
            border-radius: 0.75rem;
            background: #fff;
            transition: box-shadow 0.2s;
            max-width: 95%;
        }
        .score-page:hover {
            box-shadow: 0 6px 24px rgba(99,102,241,0.18);
        }
        .loading {
            text-align: center;
            padding: 2.5rem 1rem;
            color: #6366f1;
            font-size: 1.2rem;
            letter-spacing: 0.05em;
        }
        .loading::before {
            content: '';
            display: block;
            margin: 0 auto 1.2rem auto;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 4px solid #a5b4fc;
            border-top: 4px solid #6366f1;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .highlight {
            position: absolute;
            background: rgba(255, 255, 0, 0.4);
            border-radius: 4px;
            pointer-events: none;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div class="score-container">
        <div class="score-header">
            <button class="back-btn" onclick="window.history.back()" title="返回上一页"><i class="fas fa-arrow-left"></i></button>
            <span id="score-title" class="score-title">乐谱详情</span>
            <span></span>
        </div>
        <div id="video-bar" style="display:none; margin-bottom: 1.5rem;">
            <video id="video-player" width="100%" controls>
                <source src="欢乐颂音频/欢乐颂小提琴1.mov" type="video/mp4">
                您的浏览器不支持视频播放。
            </video>
        </div>
        <div class="audio-bar">
            <audio id="audio-player" controls class="w-full"></audio>
        </div>
        <div id="pdf-viewer">
            <div class="loading">正在加载乐谱...</div>
        </div>
    </div>
    <script>
        // 乐器配置
        const instrumentMap = {
            flute: { name: '长笛', audio: '欢乐颂音频/欢乐颂长笛.mp3', pdf: '欢乐颂乐谱/欢乐颂长笛分谱.pdf' },
            oboe: { name: '双簧管', audio: '欢乐颂音频/欢乐颂双簧管.mp3', pdf: '欢乐颂乐谱/欢乐颂双簧管分谱.pdf' },
            clarinetBb: { name: 'Bb调单簧管', audio: '欢乐颂音频/欢乐颂Bb调单簧管.mp3', pdf: '欢乐颂乐谱/欢乐颂Bb调单簧管分谱.pdf' },
            bassoon: { name: '大管', audio: '欢乐颂音频/欢乐颂大管.mp3', pdf: '欢乐颂乐谱/欢乐颂大管分谱.pdf' },
            violin1: { name: '小提琴I', audio: '欢乐颂音频/欢乐颂小提琴1.mp3', pdf: '欢乐颂乐谱/欢乐颂小提琴Ⅰ分谱.pdf' },
            violin2: { name: '小提琴II', audio: '欢乐颂音频/欢乐颂小提琴2.mp3', pdf: '欢乐颂乐谱/欢乐颂小提琴Ⅱ分谱.pdf' },
            viola: { name: '中提琴', audio: '欢乐颂音频/欢乐颂中提琴.mp3', pdf: '欢乐颂乐谱/欢乐颂中提琴分谱.pdf' },
            cello: { name: '大提琴', audio: '欢乐颂音频/欢乐颂大提琴.mp3', pdf: '欢乐颂乐谱/欢乐颂大提琴分谱.pdf' },
            doubleBass: { name: '低音提琴', audio: '欢乐颂音频/欢乐颂低音提琴.mp3', pdf: '欢乐颂乐谱/欢乐颂低音提琴分谱.pdf' },
        };

        // 获取URL参数
        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }

        const instrument = getQueryParam('instrument');
        const config = instrumentMap[instrument];
        const title = document.getElementById('score-title');
        const audio = document.getElementById('audio-player');
        const pdfViewer = document.getElementById('pdf-viewer');
        const videoBar = document.getElementById('video-bar');
        const video = document.getElementById('video-player');

        if (!config) {
            title.textContent = '未知乐器';
            pdfViewer.innerHTML = '<div class="loading">未找到该乐器的乐谱信息</div>';
        } else {
            title.textContent = config.name + '乐谱';
            audio.src = config.audio;
            // 加载PDF
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            pdfjsLib.getDocument(config.pdf).promise.then(pdfDoc => {
                pdfViewer.innerHTML = '';
                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    pdfDoc.getPage(i).then(page => {
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        const viewport = page.getViewport({ scale: 1.5 });
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        const pageDiv = document.createElement('div');
                        pageDiv.className = 'score-page';
                        pageDiv.appendChild(canvas);
                        pdfViewer.appendChild(pageDiv);
                        page.render({ canvasContext: context, viewport: viewport });
                    });
                }
            }).catch(err => {
                pdfViewer.innerHTML = `<div class='loading'>加载乐谱失败：${err.message}</div>`;
            });

            if (instrument === 'violin1') {
                videoBar.style.display = '';
                // 同步播放/暂停
                audio.addEventListener('play', () => video.play());
                audio.addEventListener('pause', () => video.pause());
                video.addEventListener('play', () => audio.play());
                video.addEventListener('pause', () => audio.pause());
                // 同步进度
                audio.addEventListener('timeupdate', () => {
                    if (Math.abs(video.currentTime - audio.currentTime) > 0.3) {
                        video.currentTime = audio.currentTime;
                    }
                });
                video.addEventListener('timeupdate', () => {
                    if (Math.abs(audio.currentTime - video.currentTime) > 0.3) {
                        audio.currentTime = video.currentTime;
                    }
                });
                // 同步快进/快退
                let isSyncing = false;
                audio.addEventListener('seeking', () => {
                    if (!isSyncing) {
                        isSyncing = true;
                        video.currentTime = audio.currentTime;
                        isSyncing = false;
                    }
                });
                video.addEventListener('seeking', () => {
                    if (!isSyncing) {
                        isSyncing = true;
                        audio.currentTime = video.currentTime;
                        isSyncing = false;
                    }
                });
            } else {
                videoBar.style.display = 'none';
            }
        }

        const scoreHighlights = {
            flute: [
                { start: 0.000, end: 2.526, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 2.526, end: 5.053, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 5.053, end: 7.579, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 7.579, end: 10.105, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 10.105, end: 12.632, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 12.632, end: 15.158, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 15.158, end: 17.684, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 17.684, end: 20.211, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 20.211, end: 22.737, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 22.737, end: 25.263, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 25.263, end: 27.789, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 27.789, end: 30.316, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 30.316, end: 32.842, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 32.842, end: 35.368, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 35.368, end: 37.895, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 37.895, end: 40.421, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 40.421, end: 42.947, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 42.947, end: 45.474, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 45.474, end: 48.000, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 48.000, end: 50.526, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 50.526, end: 53.053, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 53.053, end: 55.579, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 55.579, end: 58.105, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 58.105, end: 60.632, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 60.632, end: 63.158, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 63.158, end: 65.684, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 65.684, end: 68.211, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 68.211, end: 70.737, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 70.737, end: 73.263, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 73.263, end: 75.789, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 75.789, end: 78.316, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 78.316, end: 80.842, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 80.842, end: 83.368, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 83.368, end: 85.895, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 85.895, end: 88.421, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 88.421, end: 90.947, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 90.947, end: 93.474, page: 1, top: 0, left: 0, width: 0, height: 0 },
                { start: 93.474, end: 96.000, page: 1, top: 0, left: 0, width: 0, height: 0 }
            ],
            oboe: [
                // ...同上38个小节...
            ],
            clarinetBb: [
                // ...同上38个小节...
            ],
            bassoon: [
                // ...同上38个小节...
            ],
            violin1: [
                // ...同上38个小节...
            ],
            violin2: [
                // ...同上38个小节...
            ],
            viola: [
                // ...同上38个小节...
            ],
            cello: [
                // ...同上38个小节...
            ],
            doubleBass: [
                // ...同上38个小节...
            ]
        };

        audio.addEventListener('timeupdate', () => {
            const currentTime = audio.currentTime;
            const highlights = scoreHighlights[instrument];
            if (!highlights) return;
            // 找到当前时间对应的高亮区块
            const highlight = highlights.find(h => currentTime >= h.start && currentTime < h.end);
            // 移除旧的高亮
            document.querySelectorAll('.highlight').forEach(el => el.remove());
            // 渲染高亮
            if (highlight) {
                // 找到对应页的canvas外层div
                const pageDiv = document.querySelector(`.score-page:nth-child(${highlight.page})`);
                if (pageDiv) {
                    // 创建高亮div
                    const highlightDiv = document.createElement('div');
                    highlightDiv.className = 'highlight';
                    highlightDiv.style.top = highlight.top + 'px';
                    highlightDiv.style.left = highlight.left + 'px';
                    highlightDiv.style.width = highlight.width + 'px';
                    highlightDiv.style.height = highlight.height + 'px';
                    highlightDiv.style.position = 'absolute';
                    // 保证pageDiv是相对定位
                    pageDiv.style.position = 'relative';
                    pageDiv.appendChild(highlightDiv);
                }
            }
        });
    </script>
</body>
</html> 