{% extends "base.html" %}

{% block title %}音频资源库 - 音乐教学平台{% endblock %}

{% block content %}
    <main class="max-w-6xl mx-auto px-6 py-8">
        <!-- 页面标题 -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-medium mb-2 text-primary">音频资源库</h1>
            <p class="text-base text-secondary">探索丰富的音乐教学资源</p>
        </div>

        <!-- 搜索框 -->
        <div class="max-w-xl mx-auto mb-8">
            <div class="search-box flex items-center px-4 py-3">
                <i class="fa-solid fa-magnifying-glass mr-3 text-secondary"></i>
                <input type="text" id="searchInput" placeholder="搜索歌曲或作曲家..." 
                       class="flex-1 bg-transparent outline-none text-base text-primary">
            </div>
        </div>

        <!-- 分类按钮 -->
        <div class="flex justify-center gap-3 mb-8" id="categoryButtons">
            <!-- 分类按钮将由JS动态生成 -->
        </div>

        <!-- 音乐列表 -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="musicGrid">
            <!-- 音乐卡片将由JS动态生成 -->
        </div>
    </main>
{% endblock %}

{% block extra_js %}
    <script>
        var currentCategory = 'all';

        // 渲染分类按钮
        function renderCategoryButtons() {
            var categories = getCategories();
            var container = document.getElementById('categoryButtons');
            if (!container || !categories.length) return;

            var html = '';
            categories.forEach(function(cat) {
                var activeClass = cat.id === currentCategory ? ' active' : '';
                html += '<button class="category-btn' + activeClass + '" data-category="' + cat.id + '">' + cat.name + '</button>';
            });
            container.innerHTML = html;

            // 绑定点击事件
            container.querySelectorAll('.category-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    currentCategory = this.dataset.category;
                    // 更新按钮状态
                    container.querySelectorAll('.category-btn').forEach(function(b) {
                        b.classList.remove('active');
                    });
                    this.classList.add('active');
                    // 重新渲染列表
                    renderTrackList('musicGrid', currentCategory, 'music');
                });
            });
        }

        // 搜索功能
        function initSearch() {
            var searchInput = document.getElementById('searchInput');
            if (!searchInput) return;

            searchInput.addEventListener('input', function() {
                var keyword = this.value.trim();
                var musicGrid = document.getElementById('musicGrid');
                
                if (!keyword) {
                    renderTrackList('musicGrid', currentCategory, 'music');
                    return;
                }

                var results = searchTracks(keyword);
                var html = '';
                results.forEach(function(track) {
                    html += generateMusicCardHtml(track);
                });
                musicGrid.innerHTML = html || '<p class="text-secondary col-span-4 text-center py-8">未找到匹配的曲目</p>';
            });
        }

        // 初始化页面
        loadTracks().then(function() {
            renderCategoryButtons();
            renderTrackList('musicGrid', 'all', 'music');
            initSearch();
        }).catch(function(error) {
            console.error('加载曲目数据失败:', error);
            document.getElementById('musicGrid').innerHTML = 
                '<p class="text-secondary col-span-4 text-center py-8">加载曲目数据失败，请刷新页面重试</p>';
        });
    </script>
{% endblock %}
