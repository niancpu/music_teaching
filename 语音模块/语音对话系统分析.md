# è±†åŒ…è¯­éŸ³å¯¹è¯ç³»ç»ŸæŠ€æœ¯åˆ†ææ–‡æ¡£

## ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#1-ç³»ç»Ÿæ¦‚è¿°)
2. [ç³»ç»Ÿæ¶æ„](#2-ç³»ç»Ÿæ¶æ„)
3. [æ ¸å¿ƒæ¨¡å—åˆ†æ](#3-æ ¸å¿ƒæ¨¡å—åˆ†æ)
4. [æ•°æ®æµç¨‹è¯¦è§£](#4-æ•°æ®æµç¨‹è¯¦è§£)
5. [WebSocketåè®®åˆ†æ](#5-websocketåè®®åˆ†æ)
6. [éŸ³é¢‘å¤„ç†æµç¨‹](#6-éŸ³é¢‘å¤„ç†æµç¨‹)
7. [å…³é”®ä»£ç è§£æ](#7-å…³é”®ä»£ç è§£æ)
8. [é…ç½®è¯´æ˜](#8-é…ç½®è¯´æ˜)

---

## 1. ç³»ç»Ÿæ¦‚è¿°

æœ¬ç³»ç»Ÿæ˜¯ä¸€ä¸ªåŸºäº**å­—èŠ‚è·³åŠ¨è±†åŒ…å®æ—¶è¯­éŸ³å¯¹è¯API**çš„Webåº”ç”¨ï¼Œå®ç°äº†å®Œæ•´çš„è¯­éŸ³å¯¹è¯åŠŸèƒ½ã€‚ç”¨æˆ·å¯ä»¥é€šè¿‡æµè§ˆå™¨å½•åˆ¶è¯­éŸ³ï¼Œç³»ç»Ÿå°†è¯­éŸ³å‘é€åˆ°è±†åŒ…AIè¿›è¡Œå¤„ç†ï¼Œå¹¶å°†AIçš„è¯­éŸ³å›å¤æ’­æ”¾ç»™ç”¨æˆ·ã€‚

### 1.1 ä¸»è¦åŠŸèƒ½

- ğŸ¤ **æµè§ˆå™¨å½•éŸ³**ï¼šä½¿ç”¨Web Audio APIå½•åˆ¶ç”¨æˆ·è¯­éŸ³
- ğŸ¤– **AIå¯¹è¯**ï¼šè°ƒç”¨è±†åŒ…å®æ—¶è¯­éŸ³å¯¹è¯API
- ğŸ”Š **è¯­éŸ³æ’­æ”¾**ï¼šè‡ªåŠ¨æ’­æ”¾AIå›å¤çš„è¯­éŸ³
- ğŸ­ **è§’è‰²å®šåˆ¶**ï¼šå¯è‡ªå®šä¹‰AIè§’è‰²å’Œè¯´è¯é£æ ¼

### 1.2 æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯ |
|------|------|
| å‰ç«¯ | HTML5 + JavaScript + Web Audio API |
| åç«¯ | Python + FastAPI + asyncio |
| é€šä¿¡ | WebSocket (è±†åŒ…API) + REST API (å‰åç«¯) |
| éŸ³é¢‘ | WAV/PCMæ ¼å¼å¤„ç† |

---

## 2. ç³»ç»Ÿæ¶æ„

### 2.1 æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ç”¨æˆ·æµè§ˆå™¨                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    å‰ç«¯ (index.html + app.js)                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ å½•éŸ³æ¨¡å—  â”‚  â”‚æ ¼å¼è½¬æ¢  â”‚  â”‚ APIè°ƒç”¨  â”‚  â”‚éŸ³é¢‘æ’­æ”¾  â”‚    â”‚   â”‚
â”‚  â”‚  â”‚MediaRecorderâ”‚ WebMâ†’WAV â”‚  â”‚  fetch   â”‚  â”‚ <audio>  â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ HTTP POST (WAVæ–‡ä»¶)
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      åç«¯æœåŠ¡å™¨ (localhost:8000)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   api_server.py (FastAPI)                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚ /api/dialog  â”‚  â”‚ /api/output  â”‚  â”‚ /api/health  â”‚       â”‚   â”‚
â”‚  â”‚  â”‚   /audio     â”‚  â”‚  /{filename} â”‚  â”‚              â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                      â”‚
â”‚                              â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 audio_manager.py (DialogSession)             â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚ éŸ³é¢‘æ–‡ä»¶å¤„ç†  â”‚  â”‚  ä¼šè¯ç®¡ç†    â”‚  â”‚ å“åº”å¤„ç†     â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                      â”‚
â”‚                              â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           realtime_dialog_client.py (WebSocketå®¢æˆ·ç«¯)        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚   â”‚
â”‚  â”‚  â”‚ è¿æ¥ç®¡ç†     â”‚  â”‚ æ¶ˆæ¯å‘é€     â”‚  â”‚ æ¶ˆæ¯æ¥æ”¶     â”‚       â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                      â”‚
â”‚                              â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                   protocol.py (åè®®ç¼–è§£ç )                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚   â”‚
â”‚  â”‚  â”‚ æ¶ˆæ¯å¤´ç”Ÿæˆ   â”‚  â”‚ å“åº”è§£æ     â”‚                         â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ WebSocket (äºŒè¿›åˆ¶åè®®)
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è±†åŒ…å®æ—¶è¯­éŸ³å¯¹è¯API                                â”‚
â”‚              wss://openspeech.bytedance.com/api/v3/                 â”‚
â”‚                        realtime/dialogue                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   ASR    â”‚  â”‚   LLM    â”‚  â”‚   TTS    â”‚  â”‚  Dialog  â”‚            â”‚
â”‚  â”‚ è¯­éŸ³è¯†åˆ« â”‚  â”‚ å¤§è¯­è¨€æ¨¡å‹â”‚  â”‚ è¯­éŸ³åˆæˆ â”‚  â”‚ å¯¹è¯ç®¡ç† â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ–‡ä»¶ç»“æ„

```
è¯­éŸ³å¯¹è¯/
â”œâ”€â”€ api_server.py              # FastAPI åç«¯æœåŠ¡å…¥å£
â”œâ”€â”€ audio_manager.py           # éŸ³é¢‘ä¼šè¯ç®¡ç†å™¨
â”œâ”€â”€ config.py                  # é…ç½®æ–‡ä»¶ï¼ˆAPIå¯†é’¥ã€è§’è‰²è®¾å®šç­‰ï¼‰
â”œâ”€â”€ protocol.py                # WebSocket äºŒè¿›åˆ¶åè®®å®šä¹‰
â”œâ”€â”€ realtime_dialog_client.py  # è±†åŒ… API WebSocket å®¢æˆ·ç«¯
â”œâ”€â”€ requirements.txt           # Python ä¾èµ–
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ index.html             # å‰ç«¯é¡µé¢
â”‚   â””â”€â”€ app.js                 # å‰ç«¯é€»è¾‘
â”œâ”€â”€ uploads/                   # ä¸Šä¼ çš„å½•éŸ³æ–‡ä»¶ï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰
â””â”€â”€ outputs/                   # AI å›å¤éŸ³é¢‘æ–‡ä»¶ï¼ˆè‡ªåŠ¨æ¸…ç†ï¼‰
```

---

## 3. æ ¸å¿ƒæ¨¡å—åˆ†æ

### 3.1 api_server.py - FastAPIåç«¯æœåŠ¡

è¿™æ˜¯æ•´ä¸ªç³»ç»Ÿçš„HTTPå…¥å£ï¼Œè´Ÿè´£æ¥æ”¶å‰ç«¯è¯·æ±‚å¹¶åè°ƒå„æ¨¡å—å·¥ä½œã€‚

#### ä¸»è¦èŒè´£

1. **æ¥æ”¶éŸ³é¢‘æ–‡ä»¶**ï¼šå¤„ç†å‰ç«¯ä¸Šä¼ çš„WAVæ ¼å¼å½•éŸ³
2. **åˆ›å»ºå¯¹è¯ä¼šè¯**ï¼šå®ä¾‹åŒ–DialogSessionè¿›è¡ŒAIå¯¹è¯
3. **è¿”å›ç»“æœ**ï¼šå°†AIå›å¤çš„éŸ³é¢‘æ–‡ä»¶URLè¿”å›ç»™å‰ç«¯
4. **æ–‡ä»¶ç®¡ç†**ï¼šè‡ªåŠ¨æ¸…ç†æ—§æ–‡ä»¶ï¼Œä¿æŒå­˜å‚¨ç©ºé—´

#### APIæ¥å£

| æ¥å£ | æ–¹æ³• | åŠŸèƒ½ |
|------|------|------|
| `/` | GET | æœåŠ¡ä¿¡æ¯ |
| `/api/dialog/audio` | POST | ä¸Šä¼ å½•éŸ³è¿›è¡Œå¯¹è¯ |
| `/api/dialog/output/{filename}` | GET | è·å–AIå›å¤éŸ³é¢‘ |
| `/api/health` | GET | å¥åº·æ£€æŸ¥ |

#### æ ¸å¿ƒæµç¨‹

```python
@app.post("/api/dialog/audio")
async def dialog_with_audio(audio_file: UploadFile):
    # 1. éªŒè¯æ–‡ä»¶æ ¼å¼ï¼ˆä»…æ”¯æŒWAVï¼‰
    # 2. ç”Ÿæˆå”¯ä¸€ä»»åŠ¡IDå’Œæ—¶é—´æˆ³
    # 3. ä¿å­˜ä¸Šä¼ çš„éŸ³é¢‘æ–‡ä»¶
    # 4. åˆ›å»ºDialogSessionå®ä¾‹
    # 5. æ‰§è¡Œå¯¹è¯ï¼ˆawait session.start()ï¼‰
    # 6. ä¿å­˜AIå›å¤éŸ³é¢‘
    # 7. è¿”å›ç»“æœJSON
    # 8. æ¸…ç†æ—§æ–‡ä»¶
```

### 3.2 audio_manager.py - éŸ³é¢‘ä¼šè¯ç®¡ç†å™¨

è¿™æ˜¯å¯¹è¯æµç¨‹çš„æ ¸å¿ƒåè°ƒå™¨ï¼Œç®¡ç†æ•´ä¸ªå¯¹è¯çš„ç”Ÿå‘½å‘¨æœŸã€‚

#### DialogSessionç±»

```python
class DialogSession:
    def __init__(self, ws_config, output_audio_format, audio_file_path, recv_timeout):
        self.audio_file_path = audio_file_path  # è¾“å…¥éŸ³é¢‘è·¯å¾„
        self.recv_timeout = recv_timeout        # æ¥æ”¶è¶…æ—¶æ—¶é—´
        self.session_id = str(uuid.uuid4())     # å”¯ä¸€ä¼šè¯ID
        self.client = RealtimeDialogClient(...) # WebSocketå®¢æˆ·ç«¯
        self.audio_buffer = b''                 # AIå›å¤éŸ³é¢‘ç¼“å†²åŒº
```

#### æ ¸å¿ƒæ–¹æ³•

| æ–¹æ³• | åŠŸèƒ½ |
|------|------|
| `start()` | å¯åŠ¨å¯¹è¯ä¼šè¯ |
| `process_audio_file()` | è¯»å–å¹¶å‘é€éŸ³é¢‘æ•°æ® |
| `receive_loop()` | æ¥æ”¶æœåŠ¡å™¨å“åº” |
| `handle_server_response()` | å¤„ç†ä¸åŒç±»å‹çš„å“åº” |

#### ä¼šè¯ç”Ÿå‘½å‘¨æœŸ

```
start()
  â”‚
  â”œâ”€â†’ client.connect()           # å»ºç«‹WebSocketè¿æ¥
  â”‚
  â”œâ”€â†’ process_audio_file()       # å¼‚æ­¥ä»»åŠ¡ï¼šå‘é€éŸ³é¢‘
  â”‚     â””â”€â†’ åˆ†å—è¯»å–WAVæ–‡ä»¶
  â”‚     â””â”€â†’ æ¯å—è°ƒç”¨client.task_request()
  â”‚
  â”œâ”€â†’ receive_loop()             # ä¸»å¾ªç¯ï¼šæ¥æ”¶å“åº”
  â”‚     â””â”€â†’ æ¥æ”¶éŸ³é¢‘æ•°æ® â†’ audio_buffer
  â”‚     â””â”€â†’ æ£€æµ‹ä¼šè¯ç»“æŸäº‹ä»¶
  â”‚
  â”œâ”€â†’ client.finish_session()    # ç»“æŸä¼šè¯
  â”œâ”€â†’ client.finish_connection() # ç»“æŸè¿æ¥
  â””â”€â†’ client.close()             # å…³é—­WebSocket
```

### 3.3 realtime_dialog_client.py - WebSocketå®¢æˆ·ç«¯

è¿™æ˜¯ä¸è±†åŒ…APIé€šä¿¡çš„æ ¸å¿ƒæ¨¡å—ï¼Œå®ç°äº†å®Œæ•´çš„WebSocketåè®®äº¤äº’ã€‚

#### ä¸»è¦æ–¹æ³•

| æ–¹æ³• | äº‹ä»¶ç  | åŠŸèƒ½ |
|------|--------|------|
| `connect()` | 1, 100 | å»ºç«‹è¿æ¥å¹¶å¯åŠ¨ä¼šè¯ |
| `task_request()` | 200 | å‘é€éŸ³é¢‘æ•°æ® |
| `say_hello()` | 300 | å‘é€é—®å€™è¯­ |
| `chat_tts_text()` | 500 | å‘é€TTSæ–‡æœ¬ |
| `chat_text_query()` | 501 | å‘é€æ–‡æœ¬æŸ¥è¯¢ |
| `chat_rag_text()` | 502 | å‘é€RAGæ–‡æœ¬ |
| `finish_session()` | 102 | ç»“æŸä¼šè¯ |
| `finish_connection()` | 2 | ç»“æŸè¿æ¥ |

#### è¿æ¥å»ºç«‹æµç¨‹

```python
async def connect(self):
    # 1. å»ºç«‹WebSocketè¿æ¥
    self.ws = await websockets.connect(url, headers=headers)
    
    # 2. å‘é€StartConnectionè¯·æ±‚ï¼ˆäº‹ä»¶ç =1ï¼‰
    start_connection_request = generate_header() + event(1) + payload("{}")
    await self.ws.send(start_connection_request)
    
    # 3. å‘é€StartSessionè¯·æ±‚ï¼ˆäº‹ä»¶ç =100ï¼‰
    # åŒ…å«ASRã€TTSã€Dialogé…ç½®
    start_session_request = generate_header() + event(100) + session_id + config
    await self.ws.send(start_session_request)
```

### 3.4 protocol.py - äºŒè¿›åˆ¶åè®®

å®šä¹‰äº†ä¸è±†åŒ…APIé€šä¿¡çš„è‡ªå®šä¹‰äºŒè¿›åˆ¶åè®®æ ¼å¼ã€‚

#### æ¶ˆæ¯å¤´ç»“æ„ï¼ˆ4å­—èŠ‚ï¼‰

```
å­—èŠ‚0: [åè®®ç‰ˆæœ¬(4bit)] [å¤´éƒ¨å¤§å°(4bit)]
å­—èŠ‚1: [æ¶ˆæ¯ç±»å‹(4bit)] [æ¶ˆæ¯æ ‡å¿—(4bit)]
å­—èŠ‚2: [åºåˆ—åŒ–æ–¹å¼(4bit)] [å‹ç¼©æ–¹å¼(4bit)]
å­—èŠ‚3: [ä¿ç•™å­—æ®µ(8bit)]
```

#### æ¶ˆæ¯ç±»å‹å¸¸é‡

| å¸¸é‡ | å€¼ | æ–¹å‘ | è¯´æ˜ |
|------|-----|------|------|
| CLIENT_FULL_REQUEST | 0x01 | å®¢æˆ·ç«¯â†’æœåŠ¡å™¨ | å®Œæ•´è¯·æ±‚ |
| CLIENT_AUDIO_ONLY_REQUEST | 0x02 | å®¢æˆ·ç«¯â†’æœåŠ¡å™¨ | çº¯éŸ³é¢‘è¯·æ±‚ |
| SERVER_FULL_RESPONSE | 0x09 | æœåŠ¡å™¨â†’å®¢æˆ·ç«¯ | å®Œæ•´å“åº” |
| SERVER_ACK | 0x0B | æœåŠ¡å™¨â†’å®¢æˆ·ç«¯ | ç¡®è®¤å“åº”ï¼ˆå«éŸ³é¢‘ï¼‰ |
| SERVER_ERROR_RESPONSE | 0x0F | æœåŠ¡å™¨â†’å®¢æˆ·ç«¯ | é”™è¯¯å“åº” |

#### åºåˆ—åŒ–å’Œå‹ç¼©

| ç±»å‹ | å€¼ | è¯´æ˜ |
|------|-----|------|
| NO_SERIALIZATION | 0x00 | æ— åºåˆ—åŒ–ï¼ˆäºŒè¿›åˆ¶æ•°æ®ï¼‰ |
| JSON | 0x01 | JSONåºåˆ—åŒ– |
| GZIP | 0x01 | GZIPå‹ç¼© |

### 3.5 config.py - é…ç½®æ–‡ä»¶

åŒ…å«æ‰€æœ‰ç³»ç»Ÿé…ç½®ï¼ŒåŒ…æ‹¬APIå¯†é’¥ã€éŸ³é¢‘å‚æ•°å’ŒAIè§’è‰²è®¾å®šã€‚

#### WebSocketè¿æ¥é…ç½®

```python
ws_connect_config = {
    "base_url": "wss://openspeech.bytedance.com/api/v3/realtime/dialogue",
    "headers": {
        "X-Api-App-ID": "åº”ç”¨ID",
        "X-Api-Access-Key": "è®¿é—®å¯†é’¥",
        "X-Api-Resource-Id": "volc.speech.dialog",
        "X-Api-App-Key": "åº”ç”¨å¯†é’¥",
        "X-Api-Connect-Id": "è¿æ¥ID(UUID)",
    }
}
```

#### ä¼šè¯é…ç½®

```python
start_session_req = {
    "asr": {                          # è¯­éŸ³è¯†åˆ«é…ç½®
        "extra": {
            "end_smooth_window_ms": 1500,  # ç»“æŸå¹³æ»‘çª—å£
        },
    },
    "tts": {                          # è¯­éŸ³åˆæˆé…ç½®
        "speaker": "zh_male_yunzhou_jupiter_bigtts",  # éŸ³è‰²
        "audio_config": {
            "channel": 1,             # å•å£°é“
            "format": "pcm_s16le",    # PCMæ ¼å¼
            "sample_rate": 24000      # 24kHzé‡‡æ ·ç‡
        },
    },
    "dialog": {                       # å¯¹è¯é…ç½®
        "bot_name": "éŸ³ä¹è€å¸ˆ",       # AIåç§°
        "system_role": "...",         # ç³»ç»Ÿè§’è‰²è®¾å®š
        "speaking_style": "...",      # è¯´è¯é£æ ¼
        "location": {"city": "åŒ—äº¬"}, # ä½ç½®ä¿¡æ¯
        "extra": {
            "recv_timeout": 10,       # æ¥æ”¶è¶…æ—¶
            "input_mod": "audio"      # è¾“å…¥æ¨¡å¼
        }
    }
}
```

#### éŸ³é¢‘é…ç½®

```python
# è¾“å…¥éŸ³é¢‘ï¼ˆç”¨æˆ·å½•éŸ³ï¼‰
input_audio_config = {
    "chunk": 3200,          # æ¯å—å¤§å°
    "format": "pcm",        # PCMæ ¼å¼
    "channels": 1,          # å•å£°é“
    "sample_rate": 16000,   # 16kHzé‡‡æ ·ç‡
}

# è¾“å‡ºéŸ³é¢‘ï¼ˆAIå›å¤ï¼‰
output_audio_config = {
    "chunk": 3200,
    "format": "pcm",
    "channels": 1,
    "sample_rate": 24000,   # 24kHzé‡‡æ ·ç‡
}
```

### 3.6 å‰ç«¯æ¨¡å— (app.js)

å‰ç«¯è´Ÿè´£ç”¨æˆ·äº¤äº’ã€å½•éŸ³å’ŒéŸ³é¢‘æ’­æ”¾ã€‚

#### æ ¸å¿ƒåŠŸèƒ½

| å‡½æ•° | åŠŸèƒ½ |
|------|------|
| `init()` | åˆå§‹åŒ–ï¼Œæ£€æŸ¥æµè§ˆå™¨æ”¯æŒå’Œåç«¯çŠ¶æ€ |
| `startRecording()` | å¼€å§‹å½•éŸ³ |
| `stopRecording()` | åœæ­¢å½•éŸ³ |
| `processRecording()` | å¤„ç†å½•éŸ³å¹¶ä¸Šä¼  |
| `convertToWav()` | WebMè½¬WAVæ ¼å¼ |
| `playResponseAudio()` | æ’­æ”¾AIå›å¤ |
| `pcmToWav()` | PCMè½¬WAVæ ¼å¼ |

#### å½•éŸ³æµç¨‹

```javascript
async function startRecording() {
    // 1. è¯·æ±‚éº¦å…‹é£æƒé™
    const stream = await navigator.mediaDevices.getUserMedia({
        audio: { sampleRate: 16000, channelCount: 1 }
    });
    
    // 2. åˆ›å»ºMediaRecorder
    mediaRecorder = new MediaRecorder(stream, {
        mimeType: 'audio/webm;codecs=opus'
    });
    
    // 3. æ”¶é›†éŸ³é¢‘æ•°æ®
    mediaRecorder.ondataavailable = (e) => {
        audioChunks.push(e.data);
    };
    
    // 4. å¼€å§‹å½•éŸ³
    mediaRecorder.start(100);  // æ¯100msæ”¶é›†ä¸€æ¬¡
}
```

---

## 4. æ•°æ®æµç¨‹è¯¦è§£

### 4.1 å®Œæ•´å¯¹è¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           å®Œæ•´å¯¹è¯æµç¨‹                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·                å‰ç«¯(app.js)           åç«¯(api_server)         è±†åŒ…API
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚  1.ç‚¹å‡»å½•éŸ³æŒ‰é’®      â”‚                       â”‚                      â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                      â”‚
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚  2.å¯¹ç€éº¦å…‹é£è¯´è¯    â”‚                       â”‚                      â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                      â”‚
 â”‚                      â”‚ 3.MediaRecorder       â”‚                      â”‚
 â”‚                      â”‚   æ”¶é›†éŸ³é¢‘(WebM)      â”‚                      â”‚
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚  4.ç‚¹å‡»åœæ­¢æŒ‰é’®      â”‚                       â”‚                      â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                       â”‚                      â”‚
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚                      â”‚ 5.WebMâ†’WAVè½¬æ¢        â”‚                      â”‚
 â”‚                      â”‚   (AudioContext)      â”‚                      â”‚
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚                      â”‚ 6.POST /api/dialog/audio                     â”‚
 â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
 â”‚                      â”‚   (FormData+WAV)      â”‚                      â”‚
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚                      â”‚                       â”‚ 7.ä¿å­˜WAVæ–‡ä»¶        â”‚
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚                      â”‚                       â”‚ 8.åˆ›å»ºDialogSession  â”‚
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚                      â”‚                       â”‚ 9.WebSocketè¿æ¥      â”‚
 â”‚                      â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚                      â”‚                       â”‚ 10.StartConnection   â”‚
 â”‚                      â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                      â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚                      â”‚                       â”‚ 11.StartSession      â”‚
 â”‚                      â”‚                       â”‚   (ASR+TTS+Dialogé…ç½®)â”‚
 â”‚                      â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                      â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚                      â”‚                       â”‚ 12.åˆ†å—å‘é€éŸ³é¢‘      â”‚
 â”‚                      â”‚                       â”‚   (TaskRequest)      â”‚
 â”‚                      â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                      â”‚                       â”‚         ...          â”‚
 â”‚                      â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚                      â”‚                       â”‚ 13.æ¥æ”¶AIå›å¤        â”‚
 â”‚                      â”‚                       â”‚   (SERVER_ACK+éŸ³é¢‘)  â”‚
 â”‚                      â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                      â”‚                       â”‚         ...          â”‚
 â”‚                      â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚                      â”‚                       â”‚ 14.ä¼šè¯ç»“æŸäº‹ä»¶      â”‚
 â”‚                      â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚                      â”‚                       â”‚ 15.FinishSession     â”‚
 â”‚                      â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚                      â”‚                       â”‚ 16.FinishConnection  â”‚
 â”‚                      â”‚                       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                      â”‚                       â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚                      â”‚                       â”‚ 17.ä¿å­˜PCMéŸ³é¢‘       â”‚
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚                      â”‚ 18.è¿”å›JSONå“åº”       â”‚                      â”‚
 â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
 â”‚                      â”‚  {output_audio_url}   â”‚                      â”‚
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚                      â”‚ 19.GET /api/dialog/output/{filename}         â”‚
 â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
 â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
 â”‚                      â”‚   (PCMéŸ³é¢‘æ•°æ®)       â”‚                      â”‚
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚                      â”‚ 20.PCMâ†’WAVè½¬æ¢        â”‚                      â”‚
 â”‚                      â”‚                       â”‚                      â”‚
 â”‚  21.æ’­æ”¾AIå›å¤       â”‚                       â”‚                      â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                       â”‚                      â”‚
 â”‚                      â”‚                       â”‚                      â”‚
```

### 4.2 éŸ³é¢‘æ ¼å¼è½¬æ¢æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        éŸ³é¢‘æ ¼å¼è½¬æ¢æµç¨‹                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ã€ç”¨æˆ·å½•éŸ³é˜¶æ®µã€‘
æµè§ˆå™¨éº¦å…‹é£ â”€â”€â†’ MediaRecorder â”€â”€â†’ WebM/Opusæ ¼å¼
                                        â”‚
                                        â–¼
                              AudioContext.decodeAudioData()
                                        â”‚
                                        â–¼
                              audioBufferToWav() å‡½æ•°
                                        â”‚
                                        â–¼
                              WAVæ ¼å¼ (16kHz, 16bit, å•å£°é“)
                                        â”‚
                                        â–¼
                              ä¸Šä¼ åˆ°åç«¯æœåŠ¡å™¨

ã€åç«¯å¤„ç†é˜¶æ®µã€‘
WAVæ–‡ä»¶ â”€â”€â†’ wave.open() â”€â”€â†’ åˆ†å—è¯»å– â”€â”€â†’ gzipå‹ç¼© â”€â”€â†’ WebSocketå‘é€
                              â”‚
                              â–¼
                        æ¯å—3200å¸§ (200ms)
                              â”‚
                              â–¼
                        è±†åŒ…APIå¤„ç†

ã€AIå›å¤é˜¶æ®µã€‘
è±†åŒ…API â”€â”€â†’ PCMéŸ³é¢‘æ•°æ® â”€â”€â†’ gzipè§£å‹ â”€â”€â†’ audio_bufferç´¯ç§¯
                                              â”‚
                                              â–¼
                                        ä¿å­˜ä¸ºPCMæ–‡ä»¶
                                              â”‚
                                              â–¼
                                        è¿”å›æ–‡ä»¶URL

ã€å‰ç«¯æ’­æ”¾é˜¶æ®µã€‘
ä¸‹è½½PCMæ–‡ä»¶ â”€â”€â†’ pcmToWav() â”€â”€â†’ WAVæ ¼å¼ â”€â”€â†’ <audio>å…ƒç´ æ’­æ”¾
                    â”‚
                    â–¼
            æ·»åŠ WAVæ–‡ä»¶å¤´ (44å­—èŠ‚)
            é‡‡æ ·ç‡: 24kHz
            ä½æ·±: 16bit
            å£°é“: å•å£°é“
```

---

## 5. WebSocketåè®®åˆ†æ

### 5.1 æ¶ˆæ¯æ ¼å¼

æ¯ä¸ªWebSocketæ¶ˆæ¯ç”±ä»¥ä¸‹éƒ¨åˆ†ç»„æˆï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ¶ˆæ¯ç»“æ„                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ¶ˆæ¯å¤´ (4å­—èŠ‚)                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚ å­—èŠ‚0   â”‚ å­—èŠ‚1   â”‚ å­—èŠ‚2   â”‚ å­—èŠ‚3   â”‚                     â”‚
â”‚  â”‚ç‰ˆæœ¬|å¤´å¤§å°â”‚ç±»å‹|æ ‡å¿—â”‚åºåˆ—åŒ–|å‹ç¼©â”‚ ä¿ç•™   â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  äº‹ä»¶ç  (4å­—èŠ‚, å¤§ç«¯åº)                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¼šè¯IDé•¿åº¦ (4å­—èŠ‚, å¤§ç«¯åº) [å¯é€‰]                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¼šè¯ID (å˜é•¿) [å¯é€‰]                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è´Ÿè½½é•¿åº¦ (4å­—èŠ‚, å¤§ç«¯åº)                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è´Ÿè½½æ•°æ® (å˜é•¿, é€šå¸¸gzipå‹ç¼©)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 äº‹ä»¶ç å®šä¹‰

#### å®¢æˆ·ç«¯äº‹ä»¶ç 

| äº‹ä»¶ç  | åç§° | è¯´æ˜ |
|--------|------|------|
| 1 | StartConnection | å¼€å§‹è¿æ¥ |
| 2 | FinishConnection | ç»“æŸè¿æ¥ |
| 100 | StartSession | å¼€å§‹ä¼šè¯ï¼ˆå«é…ç½®ï¼‰ |
| 102 | FinishSession | ç»“æŸä¼šè¯ |
| 200 | TaskRequest | å‘é€éŸ³é¢‘æ•°æ® |
| 300 | SayHello | å‘é€é—®å€™è¯­ |
| 500 | ChatTTSText | å‘é€TTSæ–‡æœ¬ |
| 501 | ChatTextQuery | å‘é€æ–‡æœ¬æŸ¥è¯¢ |
| 502 | ChatRAGText | å‘é€RAGæ–‡æœ¬ |

#### æœåŠ¡å™¨äº‹ä»¶ç 

| äº‹ä»¶ç  | åç§° | è¯´æ˜ |
|--------|------|------|
| 152 | SessionFinished | ä¼šè¯ç»“æŸ |
| 153 | SessionFinished | ä¼šè¯ç»“æŸï¼ˆå¤‡ç”¨ï¼‰ |
| 359 | TTSEnd | TTSåˆæˆç»“æŸ |

### 5.3 æ¶ˆæ¯å¤´ç”Ÿæˆä»£ç 

```python
def generate_header(
    version=0b0001,                    # åè®®ç‰ˆæœ¬
    message_type=CLIENT_FULL_REQUEST,  # æ¶ˆæ¯ç±»å‹
    message_type_specific_flags=MSG_WITH_EVENT,  # æ¶ˆæ¯æ ‡å¿—
    serial_method=JSON,                # åºåˆ—åŒ–æ–¹å¼
    compression_type=GZIP,             # å‹ç¼©æ–¹å¼
    reserved_data=0x00,                # ä¿ç•™å­—æ®µ
    extension_header=bytes()           # æ‰©å±•å¤´
):
    header = bytearray()
    header_size = int(len(extension_header) / 4) + 1
    header.append((version << 4) | header_size)
    header.append((message_type << 4) | message_type_specific_flags)
    header.append((serial_method << 4) | compression_type)
    header.append(reserved_data)
    header.extend(extension_header)
    return header
```

### 5.4 å“åº”è§£ææµç¨‹

```python
def parse_response(res):
    # 1. è§£ææ¶ˆæ¯å¤´
    protocol_version = res[0] >> 4
    header_size = res[0] & 0x0f
    message_type = res[1] >> 4
    message_type_specific_flags = res[1] & 0x0f
    serialization_method = res[2] >> 4
    message_compression = res[2] & 0x0f
    
    # 2. æå–è´Ÿè½½
    payload = res[header_size * 4:]
    
    # 3. æ ¹æ®æ¶ˆæ¯ç±»å‹å¤„ç†
    if message_type == SERVER_ACK:
        # æå–äº‹ä»¶ç ã€ä¼šè¯IDã€éŸ³é¢‘æ•°æ®
        ...
    elif message_type == SERVER_ERROR_RESPONSE:
        # æå–é”™è¯¯ç å’Œé”™è¯¯ä¿¡æ¯
        ...
    
    # 4. è§£å‹å’Œååºåˆ—åŒ–
    if message_compression == GZIP:
        payload_msg = gzip.decompress(payload_msg)
    if serialization_method == JSON:
        payload_msg = json.loads(payload_msg)
    
    return result
```

---

## 6. éŸ³é¢‘å¤„ç†æµç¨‹

### 6.1 å‰ç«¯éŸ³é¢‘å½•åˆ¶

```javascript
// 1. è·å–éº¦å…‹é£æƒé™
const stream = await navigator.mediaDevices.getUserMedia({
    audio: {
        sampleRate: 16000,      // 16kHzé‡‡æ ·ç‡
        channelCount: 1,        // å•å£°é“
        echoCancellation: true, // å›å£°æ¶ˆé™¤
        noiseSuppression: true  // å™ªå£°æŠ‘åˆ¶
    }
});

// 2. åˆ›å»ºMediaRecorder
mediaRecorder = new MediaRecorder(stream, {
    mimeType: 'audio/webm;codecs=opus'  // WebMæ ¼å¼ï¼ŒOpusç¼–ç 
});

// 3. æ”¶é›†éŸ³é¢‘æ•°æ®
mediaRecorder.ondataavailable = (e) => {
    if (e.data.size > 0) {
        audioChunks.push(e.data);
    }
};

// 4. å¼€å§‹å½•éŸ³ï¼ˆæ¯100msæ”¶é›†ä¸€æ¬¡ï¼‰
mediaRecorder.start(100);
```

### 6.2 WebMè½¬WAV

```javascript
async function convertToWav(webmBlob) {
    // 1. åˆ›å»ºAudioContextï¼ˆæŒ‡å®šé‡‡æ ·ç‡ï¼‰
    const audioContext = new AudioContext({ sampleRate: 16000 });
    
    // 2. è¯»å–WebMæ•°æ®
    const arrayBuffer = await webmBlob.arrayBuffer();
    
    // 3. è§£ç éŸ³é¢‘æ•°æ®
    const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
    
    // 4. è½¬æ¢ä¸ºWAVæ ¼å¼
    const wavBuffer = audioBufferToWav(audioBuffer);
    
    return new Blob([wavBuffer], { type: 'audio/wav' });
}

function audioBufferToWav(buffer) {
    const numChannels = 1;
    const sampleRate = buffer.sampleRate;
    const bitDepth = 16;
    const samples = buffer.getChannelData(0);
    
    // åˆ›å»ºWAVæ–‡ä»¶å¤´ï¼ˆ44å­—èŠ‚ï¼‰
    const arrayBuffer = new ArrayBuffer(44 + samples.length * 2);
    const view = new DataView(arrayBuffer);
    
    // RIFFæ ‡è¯†
    writeString(view, 0, 'RIFF');
    view.setUint32(4, 36 + samples.length * 2, true);
    writeString(view, 8, 'WAVE');
    
    // fmtå­å—
    writeString(view, 12, 'fmt ');
    view.setUint32(16, 16, true);           // å­å—å¤§å°
    view.setUint16(20, 1, true);            // éŸ³é¢‘æ ¼å¼ï¼ˆPCMï¼‰
    view.setUint16(22, numChannels, true);  // å£°é“æ•°
    view.setUint32(24, sampleRate, true);   // é‡‡æ ·ç‡
    view.setUint32(28, sampleRate * 2, true); // å­—èŠ‚ç‡
    view.setUint16(32, 2, true);            // å—å¯¹é½
    view.setUint16(34, bitDepth, true);     // ä½æ·±åº¦
    
    // dataå­å—
    writeString(view, 36, 'data');
    view.setUint32(40, samples.length * 2, true);
    
    // å†™å…¥éŸ³é¢‘æ•°æ®
    let offset = 44;
    for (let i = 0; i < samples.length; i++) {
        const sample = Math.max(-1, Math.min(1, samples[i]));
        view.setInt16(offset, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
        offset += 2;
    }
    
    return arrayBuffer;
}
```

### 6.3 åç«¯éŸ³é¢‘å¤„ç†

```python
async def process_audio_file(self) -> None:
    # 1. æ‰“å¼€WAVæ–‡ä»¶
    with wave.open(self.audio_file_path, 'rb') as wf:
        chunk_size = 3200  # æ¯å—3200å¸§
        framerate = wf.getframerate()  # è·å–é‡‡æ ·ç‡
        sleep_seconds = chunk_size / framerate  # è®¡ç®—å‘é€é—´éš”
        
        # 2. åˆ†å—è¯»å–å¹¶å‘é€
        while True:
            audio_data = wf.readframes(chunk_size)
            if not audio_data:
                break
            
            # 3. å‘é€åˆ°è±†åŒ…API
            await self.client.task_request(audio_data)
            
            # 4. æŒ‰å®æ—¶é€Ÿç‡å‘é€
            await asyncio.sleep(sleep_seconds)
```

### 6.4 PCMè½¬WAVï¼ˆå‰ç«¯æ’­æ”¾ï¼‰

```javascript
function pcmToWav(pcmData, sampleRate, numChannels) {
    const dataLength = pcmData.byteLength;
    const arrayBuffer = new ArrayBuffer(44 + dataLength);
    const view = new DataView(arrayBuffer);
    
    // WAVæ–‡ä»¶å¤´
    writeString(view, 0, 'RIFF');
    view.setUint32(4, 36 + dataLength, true);
    writeString(view, 8, 'WAVE');
    writeString(view, 12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true);
    view.setUint16(22, numChannels, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * numChannels * 2, true);
    view.setUint16(32, numChannels * 2, true);
    view.setUint16(34, 16, true);
    writeString(view, 36, 'data');
    view.setUint32(40, dataLength, true);
    
    // å¤åˆ¶PCMæ•°æ®
    new Uint8Array(arrayBuffer).set(new Uint8Array(pcmData), 44);
    
    return new Blob([arrayBuffer], { type: 'audio/wav' });
}
```

---

## 7. å…³é”®ä»£ç è§£æ

### 7.1 å¯¹è¯ä¼šè¯å¯åŠ¨

```python
# audio_manager.py - DialogSession.start()
async def start(self) -> None:
    try:
        # 1. å»ºç«‹WebSocketè¿æ¥
        await self.client.connect()
        print(f"[å·²è¿æ¥] session_id: {self.session_id}")
        
        # 2. å¯åŠ¨éŸ³é¢‘å‘é€ä»»åŠ¡ï¼ˆå¼‚æ­¥ï¼‰
        asyncio.create_task(self.process_audio_file())
        
        # 3. è¿›å…¥æ¥æ”¶å¾ªç¯ï¼ˆé˜»å¡ï¼‰
        await self.receive_loop()
        
        # 4. æ¸…ç†ä¼šè¯
        await self.client.finish_session()
        while not self.is_session_finished:
            await asyncio.sleep(0.1)
        await self.client.finish_connection()
        await asyncio.sleep(0.1)
        await self.client.close()
        
        print(f"[ä¼šè¯å®Œæˆ] logid: {self.client.logid}")
        print(f"[éŸ³é¢‘æ•°æ®] æ¥æ”¶åˆ° {len(self.audio_buffer)} å­—èŠ‚")
        
    except Exception as e:
        print(f"[ä¼šè¯é”™è¯¯] {e}")
        raise
```

### 7.2 æœåŠ¡å™¨å“åº”å¤„ç†

```python
# audio_manager.py - DialogSession.handle_server_response()
def handle_server_response(self, response: Dict[str, Any]) -> None:
    if not response:
        return
        
    message_type = response.get('message_type')
    
    # å¤„ç†éŸ³é¢‘æ•°æ®
    if message_type == 'SERVER_ACK' and isinstance(response.get('payload_msg'), bytes):
        audio_data = response['payload_msg']
        self.audio_buffer += audio_data  # ç´¯ç§¯éŸ³é¢‘æ•°æ®
        
    # å¤„ç†æœåŠ¡å™¨äº‹ä»¶
    elif message_type == 'SERVER_FULL_RESPONSE':
        event = response.get('event')
        print(f"[æœåŠ¡å™¨äº‹ä»¶] event={event}")
        
    # å¤„ç†é”™è¯¯
    elif message_type == 'SERVER_ERROR':
        error_msg = response.get('payload_msg', 'æœªçŸ¥é”™è¯¯')
        print(f"[æœåŠ¡å™¨é”™è¯¯] {error_msg}")
        raise Exception(f"æœåŠ¡å™¨é”™è¯¯: {error_msg}")
```

### 7.3 éŸ³é¢‘æ•°æ®å‘é€

```python
# realtime_dialog_client.py - task_request()
async def task_request(self, audio: bytes) -> None:
    # 1. ç”Ÿæˆæ¶ˆæ¯å¤´ï¼ˆçº¯éŸ³é¢‘è¯·æ±‚ï¼Œæ— åºåˆ—åŒ–ï¼‰
    task_request = bytearray(
        protocol.generate_header(
            message_type=protocol.CLIENT_AUDIO_ONLY_REQUEST,
            serial_method=protocol.NO_SERIALIZATION
        )
    )
    
    # 2. æ·»åŠ äº‹ä»¶ç ï¼ˆ200 = TaskRequestï¼‰
    task_request.extend(int(200).to_bytes(4, 'big'))
    
    # 3. æ·»åŠ ä¼šè¯ID
    task_request.extend((len(self.session_id)).to_bytes(4, 'big'))
    task_request.extend(str.encode(self.session_id))
    
    # 4. å‹ç¼©å¹¶æ·»åŠ éŸ³é¢‘æ•°æ®
    payload_bytes = gzip.compress(audio)
    task_request.extend((len(payload_bytes)).to_bytes(4, 'big'))
    task_request.extend(payload_bytes)
    
    # 5. å‘é€
    await self.ws.send(task_request)
```

### 7.4 å‰ç«¯ä¸Šä¼ å¤„ç†

```javascript
// app.js - processRecording()
async function processRecording() {
    if (audioChunks.length === 0) {
        setStatus('å½•éŸ³æ•°æ®ä¸ºç©º', 'error');
        return;
    }
    
    recordBtn.disabled = true;
    setStatus('å¤„ç†ä¸­...');
    
    try {
        // 1. åˆå¹¶éŸ³é¢‘å—
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        
        // 2. è½¬æ¢ä¸ºWAVæ ¼å¼
        setStatus('è½¬æ¢æ ¼å¼...');
        const wavBlob = await convertToWav(audioBlob);
        
        // 3. ä¸Šä¼ åˆ°åç«¯
        setStatus('ä¸Šä¼ ä¸­ï¼ˆçº¦10-30ç§’ï¼‰...');
        const formData = new FormData();
        formData.append('audio_file', wavBlob, 'recording.wav');
        formData.append('recv_timeout', '30');
        
        const response = await fetch(`${API_BASE_URL}/api/dialog/audio`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        // 4. å¤„ç†å“åº”
        if (result.success && result.audio_received && result.output_audio_url) {
            setStatus('è·å–å›å¤...', 'success');
            await playResponseAudio(result.output_audio_url);
        } else {
            setStatus(result.message || 'æœªæ”¶åˆ°å›å¤', 'error');
        }
        
    } catch (error) {
        setStatus('é”™è¯¯: ' + error.message, 'error');
    } finally {
        recordBtn.disabled = false;
    }
}
```

---

## 8. é…ç½®è¯´æ˜

### 8.1 ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
API_APP_ID=ä½ çš„åº”ç”¨ID
API_ACCESS_KEY=ä½ çš„è®¿é—®å¯†é’¥
API_APP_KEY=ä½ çš„åº”ç”¨å¯†é’¥
```

### 8.2 AIè§’è‰²å®šåˆ¶

ä¿®æ”¹ `config.py` ä¸­çš„ `start_session_req.dialog`ï¼š

```python
"dialog": {
    "bot_name": "éŸ³ä¹è€å¸ˆ",  # AIåç§°
    "system_role": """
        ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„éŸ³ä¹æ•™å¸ˆï¼Œæ‹¥æœ‰ä¸°å¯Œçš„éŸ³ä¹ç†è®ºçŸ¥è¯†å’Œæ•™å­¦ç»éªŒã€‚
        ä½ æ“…é•¿é’¢ç´ã€å£°ä¹å’Œä¹ç†æ•™å­¦ï¼Œå¯¹å¤å…¸éŸ³ä¹ã€æµè¡ŒéŸ³ä¹éƒ½æœ‰æ·±å…¥äº†è§£ã€‚
        ä½ çƒ­çˆ±éŸ³ä¹æ•™è‚²ï¼Œå–„äºç”¨é€šä¿—æ˜“æ‡‚çš„æ–¹å¼è®²è§£å¤æ‚çš„éŸ³ä¹æ¦‚å¿µï¼Œ
        èƒ½å¤Ÿæ ¹æ®å­¦ç”Ÿçš„æ°´å¹³è°ƒæ•´æ•™å­¦å†…å®¹ã€‚
    """,
    "speaking_style": """
        ä½ çš„è¯´è¯é£æ ¼æ¸©å’Œè€å¿ƒï¼Œå–„äºé¼“åŠ±å­¦ç”Ÿã€‚
        è®²è§£æ—¶ä¼šç”¨ç”ŸåŠ¨çš„æ¯”å–»å¸®åŠ©ç†è§£ï¼Œè¯­é€Ÿé€‚ä¸­ï¼Œè¯­è°ƒå¯Œæœ‰æ„ŸæŸ“åŠ›ã€‚
    """,
}
```

### 8.3 è¯­éŸ³éŸ³è‰²

ä¿®æ”¹ `config.py` ä¸­çš„ `start_session_req.tts.speaker`ï¼š

```python
"tts": {
    "speaker": "zh_male_yunzhou_jupiter_bigtts",  # éŸ³è‰²ID
}
```

### 8.4 éŸ³é¢‘å‚æ•°

| å‚æ•° | è¾“å…¥ï¼ˆç”¨æˆ·å½•éŸ³ï¼‰ | è¾“å‡ºï¼ˆAIå›å¤ï¼‰ |
|------|------------------|----------------|
| æ ¼å¼ | WAV/PCM | PCM |
| é‡‡æ ·ç‡ | 16kHz | 24kHz |
| ä½æ·± | 16bit | 16bit |
| å£°é“ | å•å£°é“ | å•å£°é“ |

---

## 9. æ€»ç»“

### 9.1 ç³»ç»Ÿç‰¹ç‚¹

1. **å‰åç«¯åˆ†ç¦»**ï¼šå‰ç«¯è´Ÿè´£å½•éŸ³å’Œæ’­æ”¾ï¼Œåç«¯è´Ÿè´£ä¸AIé€šä¿¡
2. **å¼‚æ­¥å¤„ç†**ï¼šä½¿ç”¨asyncioå®ç°å¹¶å‘çš„éŸ³é¢‘å‘é€å’Œæ¥æ”¶
3. **äºŒè¿›åˆ¶åè®®**ï¼šè‡ªå®šä¹‰çš„WebSocketåè®®ï¼Œæ”¯æŒgzipå‹ç¼©
4. **å®æ—¶æµå¼**ï¼šéŸ³é¢‘åˆ†å—å‘é€ï¼Œæ”¯æŒå®æ—¶å¯¹è¯
5. **è‡ªåŠ¨æ¸…ç†**ï¼šå®šæœŸæ¸…ç†æ—§æ–‡ä»¶ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´

### 9.2 æŠ€æœ¯äº®ç‚¹

- **Web Audio API**ï¼šæµè§ˆå™¨ç«¯éŸ³é¢‘å½•åˆ¶å’Œæ ¼å¼è½¬æ¢
- **WebSocket**ï¼šä¸è±†åŒ…APIçš„å®æ—¶åŒå‘é€šä¿¡
- **FastAPI**ï¼šé«˜æ€§èƒ½çš„Pythonå¼‚æ­¥Webæ¡†æ¶
- **gzipå‹ç¼©**ï¼šå‡å°‘ç½‘ç»œä¼ è¾“æ•°æ®é‡

### 9.3 æ‰©å±•æ–¹å‘

1. **å®æ—¶æµå¼æ’­æ”¾**ï¼šè¾¹æ¥æ”¶è¾¹æ’­æ”¾AIå›å¤
2. **å¤šè½®å¯¹è¯**ï¼šä¿æŒä¼šè¯ä¸Šä¸‹æ–‡
3. **è¯­éŸ³æ‰“æ–­**ï¼šæ”¯æŒç”¨æˆ·æ‰“æ–­AIå›å¤
4. **å¤šè¯­è¨€æ”¯æŒ**ï¼šæ”¯æŒæ›´å¤šè¯­è¨€çš„è¯­éŸ³è¯†åˆ«å’Œåˆæˆ
5. **WebRTC**ï¼šä½¿ç”¨WebRTCå®ç°æ›´ä½å»¶è¿Ÿçš„å®æ—¶é€šä¿¡

---

## 10. ä¸»é¡¹ç›®é›†æˆè¯´æ˜

### 10.1 è¿ç§»åçš„æ¶æ„

è¯­éŸ³æ¨¡å—å·²é›†æˆåˆ°ä¸»é¡¹ç›®çš„ Next.js å‰ç«¯ä¸­ï¼Œæ¶æ„å¦‚ä¸‹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸»é¡¹ç›®å‰ç«¯ (Next.js + React)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 frontend/src/app/page.tsx                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚              AIéŸ³ä¹æ•™å¸ˆè¯­éŸ³äº’åŠ¨ Section               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚         VoiceChat.tsx (Reactç»„ä»¶)              â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  - å½•éŸ³åŠŸèƒ½ (MediaRecorder)                    â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  - æ ¼å¼è½¬æ¢ (WebMâ†’WAV, PCMâ†’WAV)               â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  - APIè°ƒç”¨ (fetch)                            â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  - éŸ³é¢‘æ’­æ”¾ (<audio>)                         â”‚  â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ HTTP (ç«¯å£8000)
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è¯­éŸ³å¯¹è¯åç«¯ (ä¿æŒä¸å˜)                              â”‚
â”‚  api_server.py â†’ audio_manager.py â†’ realtime_dialog_client.py      â”‚
â”‚                                    â†’ protocol.py                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ WebSocket
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         è±†åŒ…å®æ—¶è¯­éŸ³å¯¹è¯API                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 10.2 æ–°å¢æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|----------|------|
| `frontend/src/components/VoiceChat.tsx` | Reactè¯­éŸ³å¯¹è¯ç»„ä»¶ |
| `frontend/.env.local.example` | ç¯å¢ƒå˜é‡ç¤ºä¾‹ï¼ˆå«NEXT_PUBLIC_VOICE_API_URLï¼‰ |

### 10.3 ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹å†…å®¹ |
|----------|----------|
| `frontend/src/app/page.tsx` | æ·»åŠ VoiceChatç»„ä»¶å’ŒAIè¯­éŸ³äº’åŠ¨Section |

### 10.4 ç¯å¢ƒå˜é‡é…ç½®

åœ¨ `frontend/.env.local` ä¸­é…ç½®ï¼š

```bash
# è¯­éŸ³å¯¹è¯APIåœ°å€
NEXT_PUBLIC_VOICE_API_URL=http://localhost:8000
```

### 10.5 å¯åŠ¨æ–¹å¼

1. **å¯åŠ¨è¯­éŸ³å¯¹è¯åç«¯**ï¼š
   ```bash
   cd è¯­éŸ³å¯¹è¯
   python api_server.py
   ```

2. **å¯åŠ¨ä¸»é¡¹ç›®å‰ç«¯**ï¼š
   ```bash
   cd frontend
   npm run dev
   ```

3. **è®¿é—®ä¸»é¡µ**ï¼šæ‰“å¼€ http://localhost:3000ï¼Œæ»šåŠ¨åˆ°"AIéŸ³ä¹æ•™å¸ˆè¯­éŸ³äº’åŠ¨"åŒºåŸŸ

### 10.6 æŠ€æœ¯å˜æ›´

| åŸå®ç° | è¿ç§»å |
|--------|--------|
| åŸç”ŸJavaScript (app.js) | React + TypeScript (VoiceChat.tsx) |
| ç‹¬ç«‹HTMLé¡µé¢ | é›†æˆåˆ°Next.jsä¸»é¡µ |
| å…¨å±€å˜é‡ç®¡ç†çŠ¶æ€ | React useState/useRefç®¡ç†çŠ¶æ€ |
| DOMæ“ä½œ | Reactå£°æ˜å¼æ¸²æŸ“ |
| æ— ç±»å‹æ£€æŸ¥ | TypeScriptç±»å‹å®‰å…¨ |

### 10.7 ä¿æŒä¸å˜çš„éƒ¨åˆ†

- åç«¯æ¶æ„å®Œå…¨ä¸å˜
- APIæ¥å£ä¸å˜
- WebSocketåè®®ä¸å˜
- éŸ³é¢‘å¤„ç†é€»è¾‘ä¸å˜ï¼ˆä»…ä»JSè½¬æ¢ä¸ºTSï¼‰
